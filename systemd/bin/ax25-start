#!/bin/bash
#
# Script to start up direwolf & AX.25 services
# The script enables & starts the services

SPEED_FILE="/etc/ax25/packet_9600baud"
SERVICE_LIST="direwolf.service ax25dev.path ax25dev.service ax25-mheardd.service ax25d.service"
SYSTEMCTL="systemctl"

# ===== function start_service

function start_service() {
    service="$1"
    echo "Starting: $service"

    systemctl is-enabled "$service" > /dev/null 2>&1
    if [ $? -ne 0 ] ; then
        echo "ENABLING $service"
        $SYSTEMCTL enable "$service"
        if [ "$?" -ne 0 ] ; then
            echo "Problem ENABLING $service"
            exit
        fi
    fi

    $SYSTEMCTL --no-pager start "$service"
    if [ "$?" -ne 0 ] ; then
        echo "Problem starting $service"
        systemctl status $service
        exit
    fi
}

# ===== main

# Check if direwolf is already running.
pid=$(pidof direwolf)
if [ $? -eq 0 ] ; then
    echo "Direwolf already running with a pid of $pid ... exiting."
    exit 1
fi

# Check if running as root
if [[ $EUID != 0 ]] ; then
   echo "set sudo"
   SYSTEMCTL="sudo systemctl"
fi

MODEM_SPEED="1200"
if [ -e "$SPEED_FILE" ] ; then
    MODEM_SPEED="9600"
fi
echo
echo "STARTING AX.25/Direwolf as $MODEM_SPEED baud modem."

for service in `echo ${SERVICE_LIST}` ; do
    start_service $service
done
